{
  if (!rb.doFacets || rb.stage != ResponseBuilder.STAGE_GET_FIELDS)   return;
  long t1=System.currentTimeMillis();
  FacetInfo fi=rb._facetInfo;
  NamedList facet_counts=new SimpleOrderedMap();
  NamedList facet_queries=new SimpleOrderedMap();
  facet_counts.add("facet_queries",facet_queries);
  for (  QueryFacet qf : fi.queryFacets.values()) {
    facet_queries.add(qf.getKey(),qf.count);
  }
  NamedList facet_fields=new SimpleOrderedMap();
  facet_counts.add("facet_fields",facet_fields);
  for (  DistribFieldFacet dff : fi.facets.values()) {
    NamedList fieldCounts=new NamedList();
    facet_fields.add(dff.getKey(),fieldCounts);
    int saverecords=dff.offset + dff.limit;
    GroupbyItem[] counts=dff.getPairSorted(dff.sort_column_type,dff.joinSort,dff.facetFs,dff.crossFs,dff.distFS,dff.sort_fl,dff.sort_type,dff.isdesc,saverecords);
    if (dff.recordcount != null) {
      GroupbyItem recordcount=dff.recordcount;
      fieldCounts.add(recordcount.getKey(),recordcount.toNamedList());
    }
    int end=dff.limit < 0 ? counts.length : Math.min(dff.offset + dff.limit,counts.length);
    for (int i=dff.offset; i < end; i++) {
      fieldCounts.add(counts[i].getKey(),counts[i].toNamedList());
    }
  }
  facet_counts.add("facet_dates",new SimpleOrderedMap());
  facet_counts.add("facet_ranges",new SimpleOrderedMap());
  rb.rsp.add("facet_counts",facet_counts);
  rb._facetInfo=null;
  long t2=System.currentTimeMillis();
  LOG.info("##finishStage## time taken " + (t2 - t1));
}
